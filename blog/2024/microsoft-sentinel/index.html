<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Enhancing Security with Sentinel Queries:- Real-World Use Cases | Teklit H. Gebremariam</title> <meta name="author" content="Teklit H. Gebremariam"> <meta name="description" content="In this blog post, I will be discussing various query rules and hunting queries that can be used by SOC analysts to detect and investigate security incidents using Microsoft Sentinel."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="/assets/img/engd_pic_rect.ico?46f936528efc85d279f011e347843fd3"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://teklithaphtu.com/blog/2024/microsoft-sentinel/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?6185d15ea1982787ad7f435576553d64"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Teklit </span>H. Gebremariam</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item "> <a class="nav-link" href="/news/">news</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">Enhancing Security with Sentinel Queries:- Real-World Use Cases</h1> <p class="post-meta">April 25, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/soc"> <i class="fa-solid fa-hashtag fa-sm"></i> soc,</a>   <a href="/blog/tag/microsoft"> <i class="fa-solid fa-hashtag fa-sm"></i> microsoft,</a>   <a href="/blog/tag/sentinel"> <i class="fa-solid fa-hashtag fa-sm"></i> sentinel,</a>   <a href="/blog/tag/kql"> <i class="fa-solid fa-hashtag fa-sm"></i> KQL</a>     ·   <a href="/blog/category/security"> <i class="fa-solid fa-tag fa-sm"></i> security</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Microsoft Sentinel is a cloud-based SIEM (Security Information and Event Management) and SOAR (Security Orchestration, Automation, and Response) solution designed to detect, investigate, respond to, and hunt threats across enterprise infrastructures and products. Under the hood, it is an ocean of logs collected from various network devices and applications, ingested through data connectors and enhanced by machine learning, KQL (Kusto Query Language—a custom query language), and analytics, to name a few.</p> <p>In this blog post, I provide Kusto queries for various real world use cases to stay fit your organizational security posture. From identifying unauthorized access attempts to monitoring network traffic and detecting malicious activities, these queries will help you proactively secure your environment.</p> <p>In case you are new to Sentinel, I recommend checking out the <a href="https://docs.microsoft.com/en-us/azure/sentinel/overview" rel="external nofollow noopener" target="_blank">official documentation</a> and the following <a href="https://www.youtube.com/watch?v=xMj7a4Ns_cU" rel="external nofollow noopener" target="_blank">youtube video</a> to get started.</p> <p>Success!!</p> <h2 id="detecting-access-from-the-tor-network">Detecting Access from the Tor Network</h2> <p><strong>Description</strong>: Adversaries often use the VPN and Tor network to hide and anonymize their activities, making it challenging to trace their origin. They sometimes use Tor to access internal resources, exfiltrate data, or conduct brute force authentication attempts. This query can detect and alert on any login attempts from Tor browsers. To implement this, you’ll need to create a watchlist of known Tor exit nodes and upload it to Sentinel. You can find a list of Tor exit nodes <a href="https://check.torproject.org/exit-addresses" rel="external nofollow noopener" target="_blank">here</a> or <a href="https://github.com/SecOps-Institute/Tor-IP-Addresses" rel="external nofollow noopener" target="_blank">here</a>.</p> <p><strong>Query</strong>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Retrieve list of Tor exit nodes IPs from the watchlist</span>
<span class="kd">let</span> <span class="nx">watchlist</span> <span class="o">=</span> <span class="p">(</span><span class="nc">_GetWatchlist</span><span class="p">(</span><span class="dl">'</span><span class="s1">TorExitNodes</span><span class="dl">'</span><span class="p">)</span> <span class="o">|</span> <span class="nx">project</span> <span class="nx">TorIPAddress</span><span class="p">);</span>
<span class="c1">// SigninLogs from the past 5 minutes</span>
<span class="nx">SigninLogs</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">TimeGenerated</span> <span class="o">&gt;</span> <span class="nf">ago</span><span class="p">(</span><span class="mi">5</span><span class="nx">m</span><span class="p">)</span>
<span class="c1">// Check if the IPAddress from SigninLogs is in the watchlist</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">IPAddress</span> <span class="k">in </span><span class="p">(</span><span class="nx">watchlist</span><span class="p">)</span>
<span class="o">|</span> <span class="nx">project</span> <span class="nx">TimeGenerated</span><span class="p">,</span> <span class="nx">IPAddress</span>
</code></pre></div></div> <p><strong>Test</strong>: To trigger this alert, anyone can use a Tor browser and attempt to log in to https://portal.azure.com.</p> <h2 id="detecting-logins-from-blacklisted-ips">Detecting Logins from Blacklisted IPs</h2> <p><strong>Description</strong>: If a certain IP address has been used in the past for attack in the past, there is a high probability that a later successful login from that IP address is malicious. This rule detects logins from any of the black list of IPs that has previously been compiled by a system administrator.</p> <p><strong>Query</strong>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">blacklistIPs</span> <span class="o">=</span> <span class="nc">_GetWatchlist</span><span class="p">(</span><span class="dl">'</span><span class="s1">blacklistOfIps</span><span class="dl">'</span><span class="p">)</span> <span class="o">|</span> <span class="nx">project</span> <span class="nx">ip</span><span class="p">;</span>
<span class="c1">// Load the list of list blacklisted IPs</span>
<span class="nx">SigninLogs</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">ResultType</span> <span class="o">==</span> <span class="mi">0</span>
<span class="c1">// Only successful logins</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">IPAddress</span> <span class="k">in </span><span class="p">(</span><span class="nx">blacklistIPs</span><span class="p">)</span>
<span class="c1">// IP address matches blacklisted IPs</span>
<span class="o">|</span> <span class="nx">project</span> <span class="nx">TimeGenerated</span><span class="p">,</span> <span class="nx">IPAddress</span><span class="p">,</span> <span class="nx">AccountDisplayName</span>
</code></pre></div></div> <p><strong>Test</strong>: To test this rule and to trigger the alert, use a VPN to switch to a known bad IP and then log in.</p> <h2 id="detecting-communication-with-a-cc-server">Detecting Communication with a C&amp;C Server</h2> <p>Command and Control (C&amp;C) servers, as it names speak, are launching pad for cyber criminals used to communicate with compromised systems, often to exfiltrate data or send malicious commands. This query checks for any incoming successful communication from a known blacklisted C&amp;C IP. An external data source is used to create the blacklist of C&amp;C server IPs. Identifying such communications can help in detecting and mitigating ongoing attacks.</p> <p><strong>Query</strong>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">BlockList</span> <span class="o">=</span>
    <span class="p">(</span><span class="nf">externaldata</span><span class="p">(</span><span class="nx">ip</span><span class="p">:</span><span class="nx">string</span><span class="p">)</span>
    <span class="p">[@</span><span class="dl">"</span><span class="s2">https://rules.emergingthreats.net/blockrules/compromised-ips.txt</span><span class="dl">"</span>
    <span class="p">]</span>
    <span class="nf">with</span><span class="p">(</span><span class="nx">format</span><span class="o">=</span><span class="dl">"</span><span class="s2">csv</span><span class="dl">"</span><span class="p">)</span>
    <span class="o">|</span> <span class="nx">where</span> <span class="nx">ip</span> <span class="nx">matches</span> <span class="nx">regex</span> <span class="dl">"</span><span class="s2">(^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</span><span class="se">\\\\</span><span class="s2">.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</span><span class="se">\\\\</span><span class="s2">.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)</span><span class="se">\\\\</span><span class="s2">.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$)</span><span class="dl">"</span>
    <span class="o">|</span> <span class="nx">distinct</span> <span class="nx">ip</span>
<span class="p">);</span>
<span class="nx">SigninLogs</span>
<span class="o">|</span> <span class="nx">sort</span> <span class="nx">by</span> <span class="nx">TimeGenerated</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">IPAddress</span> <span class="k">in </span><span class="p">(</span><span class="nx">BlockList</span><span class="p">)</span> <span class="nx">or</span> <span class="nx">IPAddress</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">85.145.247.7</span><span class="dl">"</span>
<span class="c1">// Add specific IP for testing</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">ResultType</span> <span class="o">==</span> <span class="mi">0</span>
<span class="c1">// Only successful logins</span>
<span class="o">|</span> <span class="nx">project</span> <span class="nx">TimeGenerated</span><span class="p">,</span> <span class="nx">OperationName</span><span class="p">,</span> <span class="nx">Identity</span><span class="p">,</span> <span class="nx">IPAddress</span><span class="p">,</span> <span class="nx">DeviceDetail</span>

</code></pre></div></div> <p><strong>Test</strong>: To test this rule, add your IP to the list of known C&amp;C server IPs and attempt a login.</p> <h2 id="how-to-deal-with-account-enumeration-attacks">How to Deal With Account Enumeration Attacks</h2> <p>An adversary can use account enumeration attacks to identify valid usernames and password. This query targets a tactic commonly used by adversaries: account detection attacks leveraging Brute Force (T1087) from the MITRE ATT&amp;CK framework;For more information follow this <a href="https://attack.mitre.org/techniques/T1087/" rel="external nofollow noopener" target="_blank">link</a>. It identifies a surge in login attempts from a single IP targeting multiple user accounts, a potential sign of brute-forcing valid accounts.</p> <p><strong>Query</strong>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">BorderValue</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">SigninLogs</span>
<span class="o">|</span> <span class="nx">distinct</span> <span class="nx">UserDisplayName</span><span class="p">,</span> <span class="nx">IPAddress</span>
<span class="o">|</span> <span class="nx">summarize</span> <span class="nx">AmountOfAccounts</span> <span class="o">=</span> <span class="nf">count</span><span class="p">(),</span> <span class="nx">Adresses</span> <span class="o">=</span> <span class="nf">make_list</span><span class="p">(</span><span class="nx">UserDisplayName</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="nx">by</span> <span class="nx">IPAddress</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">AmountOfAccounts</span> <span class="o">&gt;=</span> <span class="nx">BorderValue</span>
</code></pre></div></div> <h2 id="detecting-mfa-fatigue-attacks">Detecting MFA Fatigue Attacks</h2> <p>MFA fatigue attacks exploit a user’s frustration with repeated MFA prompts, aiming to bypass security by overwhelming the user with requests. This method is dangerous because it requires valid credentials, making it a high-risk attack. If the user inadvertently approves one of the persistent MFA requests, the attacker gains access.</p> <p>To detect such attacks, we can use Microsoft Sentinel to monitor for repeated occurrences of error code 500121—indicating strong authentication failures. Specifically, if more than three such failures occur from the same account within 10 minutes, it could signal an MFA fatigue attack.</p> <p>This tactic aligns with MITRE ATT&amp;CK’s <a href="https://attack.mitre.org/techniques/T1621/" rel="external nofollow noopener" target="_blank">T1621</a> under the Credential Access category, which covers methods like MFA Request Generation.</p> <p><strong>Query</strong>:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// KQL Query to detect MFA Fatigue Attacks</span>
<span class="nx">SigninLogs</span>
<span class="c1">// Filtering for strong authentication failures</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">ResultType</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">500121</span><span class="dl">"</span>
<span class="c1">// Aggregating failed attempts by account within 10-minute intervals</span>
<span class="o">|</span> <span class="nx">summarize</span> <span class="nx">FailureCount</span> <span class="o">=</span> <span class="nf">count</span><span class="p">()</span> <span class="nx">by</span> <span class="nx">Identity</span><span class="p">,</span> <span class="nf">bin</span><span class="p">(</span><span class="nx">TimeGenerated</span><span class="p">,</span> <span class="mi">10</span><span class="nx">m</span><span class="p">)</span>
<span class="c1">// Flagging instances where more than three failures occurred</span>
<span class="o">|</span> <span class="nx">where</span> <span class="nx">FailureCount</span> <span class="o">&gt;</span> <span class="mi">3</span>
</code></pre></div></div> <p><strong>Test</strong> To test this rule, attempt to log in to a service that requires MFA and intentionally fail the MFA prompt three times.</p> </div> </article><div id="giscus_thread" style="max-width: 990px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"greenzemg/greenzemg.github.io","data-repo-id":"R_kgDOJKkI3Q","data-category":"Announcements","data-category-id":"DIC_kwDOJKkI3c4CfdyM","data-mapping":"title","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"1","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Teklit H. Gebremariam. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. <a href="https://teklithaphtu.comtrue">Impressum</a>.Last updated: March 16, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?9b43d6e67ddc7c0855b1478ee4c48c2d" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-BEWL3WJDH"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BEWL3WJDH");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>